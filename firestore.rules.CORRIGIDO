rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== FUN√á√ïES AUXILIARES (DEVEM VIR PRIMEIRO) =====
    
    // Verifica se usu√°rio √© admin
    function isAdmin(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return userDoc.data.isAdmin == true;
    }
    
    // Verifica se usu√°rio √© participante de um match
    function isMatchParticipant(matchId, userId) {
      let matchDoc = get(/databases/$(database)/documents/matches/$(matchId));
      return userId == matchDoc.data.user1Id || userId == matchDoc.data.user2Id;
    }
    
    // Verifica se usu√°rio √© participante de um chat
    function isChatParticipant(chatId, userId) {
      let chatDoc = get(/databases/$(database)/documents/match_chats/$(chatId));
      return isMatchParticipant(chatDoc.data.matchId, userId);
    }
    
    // Regras para usu√°rios
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null; // Permitir leitura para busca de usu√°rios
    }
    
    // Regras para convites de parceria
    match /purpose_invites/{inviteId} {
      allow create: if request.auth != null && 
        request.auth.uid == resource.data.fromUserId;
      allow read, update: if request.auth != null && 
        (request.auth.uid == resource.data.fromUserId || 
         request.auth.uid == resource.data.toUserId);
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.fromUserId;
    }
    
    // Regras para parcerias estabelecidas
    match /purpose_partnerships/{partnershipId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.user1Id || 
         request.auth.uid == resource.data.user2Id);
      allow create: if request.auth != null;
    }
    
    // Regras para chats compartilhados do prop√≥sito
    match /purpose_chats/{chatId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.participantIds;
      allow create: if request.auth != null;
    }
    
    // Regras para mensagens dos chats compartilhados
    match /purpose_chats/{chatId}/messages/{messageId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/purpose_chats/$(chatId)).data.participantIds;
      allow create: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/purpose_chats/$(chatId)).data.participantIds &&
        request.auth.uid == request.resource.data.senderId;
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.senderId;
    }
    
    // Regras para lista de usu√°rios bloqueados
    match /blocked_users/{blockId} {
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.blockerUserId;
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.blockerUserId || 
         request.auth.uid == resource.data.blockedUserId);
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.blockerUserId;
    }
    
    // Regras para chats existentes (manter compatibilidade)
    match /chats/{chatId} {
      allow read, write: if request.auth != null;
    }
    
    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para stories E SUBCOLE√á√ïES
    match /stories/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para stories visualizados (stores_visto)
    match /stores_visto/{docId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para arquivos de stories (stories_files)
    match /stories_files/{storyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para stories Sinais Isaque
    match /stories_sinais_isaque/{storyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para stories Sinais Rebeca
    match /stories_sinais_rebeca/{storyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regra expl√≠cita para cole√ß√£o sistema E SUBCOLE√á√ïES
    match /sistema/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para logs da aplica√ß√£o
    match /app_logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false; // Logs s√£o imut√°veis
    }
    
    // ‚úÖ CORRIGIDO: Regras para certifica√ß√µes (alias de certification_requests)
    match /certifications/{certificationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para notifica√ß√µes de interesse E SUBCOLE√á√ïES
    match /interest_notifications/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Regras para notifica√ß√µes
    match /notifications/{notificationId} {
      // Usu√°rio s√≥ pode ler suas pr√≥prias notifica√ß√µes
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      
      // Usu√°rio s√≥ pode marcar suas notifica√ß√µes como lidas
      // Permitir atualiza√ß√£o de 'isRead' OU 'read' (ambos os campos s√£o usados)
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId &&
                       (request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['isRead']) ||
                       request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['read', 'readAt']) ||
                       request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['read']));
      
      // Sistema pode criar notifica√ß√µes (qualquer usu√°rio autenticado)
      allow create: if request.auth != null;
      
      // Usu√°rio pode deletar suas pr√≥prias notifica√ß√µes
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // Regras para usu√°rios (corrigir nome da cole√ß√£o)
    match /usuarios/{userId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== REGRAS PARA SISTEMA DE MATCHES =====
    
    // Regras para matches
    match /matches/{matchId} {
      // Usu√°rio pode ler matches onde √© participante
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.user1Id || 
         request.auth.uid == resource.data.user2Id);
      
      // Usu√°rio pode criar match (sistema de convites)
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.user1Id || 
         request.auth.uid == request.resource.data.user2Id) &&
        request.resource.data.keys().hasAll(['user1Id', 'user2Id', 'matchedAt', 'chatExpiresAt']) &&
        request.resource.data.isActive == true &&
        request.resource.data.chatEnabled == true;
      
      // Usu√°rio pode atualizar match (√∫ltima mensagem, status de leitura, etc.)
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.user1Id || 
         request.auth.uid == resource.data.user2Id) &&
        // N√£o pode alterar IDs dos usu√°rios ou data do match
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['user1Id', 'user2Id', 'matchedAt']);
      
      // Usu√°rio pode desativar match (reportar/bloquear)
      allow delete: if request.auth != null && 
        (request.auth.uid == resource.data.user1Id || 
         request.auth.uid == resource.data.user2Id);
    }
    
    // ‚úÖ CORRIGIDO: Regras para chats de matches E SUBCOLE√á√ïES
    match /match_chats/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para mensagens de matches
    match /match_messages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if false;
    }
    
    // Regras para interesses m√∫tuos (compatibilidade com sistema antigo)
    match /mutual_interests/{interestId} {
      // Usu√°rio pode ler se for participante
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.user1Id || 
         request.auth.uid == resource.data.user2Id);
      
      // Usu√°rio pode criar interesse m√∫tuo
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.user1Id || 
         request.auth.uid == request.resource.data.user2Id);
      
      // Usu√°rio pode atualizar status
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.user1Id || 
         request.auth.uid == resource.data.user2Id);
    }
    
    // Regras para notifica√ß√µes agendadas (sistema de expira√ß√£o)
    match /scheduled_notifications/{notificationId} {
      // Apenas sistema pode gerenciar notifica√ß√µes agendadas
      allow read, write: if request.auth != null;
    }
    
    // ‚úÖ CORRIGIDO: Regras para perfis espirituais E SUBCOLE√á√ïES
    match /spiritual_profiles/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // ===== REGRAS PARA SISTEMA DE SINAIS (RECOMENDA√á√ïES SEMANAIS) =====
    
    // ‚úÖ CORRIGIDO: Regras para perfis p√∫blicos E SUBCOLE√á√ïES
    match /profiles/{document=**} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Regras para recomenda√ß√µes semanais
    match /weeklyRecommendations/{docId} {
      // Usu√°rio pode ler suas pr√≥prias recomenda√ß√µes
      // docId formato: userId_weekKey
      allow read: if request.auth != null && 
        docId.matches('^' + request.auth.uid + '_.*');
      
      // Sistema pode criar/atualizar recomenda√ß√µes
      allow create, update: if request.auth != null && 
        docId.matches('^' + request.auth.uid + '_.*');
      
      // Usu√°rio pode deletar suas pr√≥prias recomenda√ß√µes
      allow delete: if request.auth != null && 
        docId.matches('^' + request.auth.uid + '_.*');
    }
    
    // ‚úÖ CORRIGIDO: Regras para interesses demonstrados E SUBCOLE√á√ïES
    match /interests/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Regras para filtros de busca do usu√°rio
    match /searchFilters/{userId} {
      // Usu√°rio pode ler seus pr√≥prios filtros
      allow read: if request.auth != null && 
        request.auth.uid == userId;
      
      // Usu√°rio pode criar/atualizar seus pr√≥prios filtros
      allow create, update: if request.auth != null && 
        request.auth.uid == userId;
      
      // Usu√°rio pode deletar seus pr√≥prios filtros
      allow delete: if request.auth != null && 
        request.auth.uid == userId;
    }
    
    // ===== REGRAS PARA SISTEMA DE CERTIFICA√á√ïES =====
    
    // Regras para solicita√ß√µes de certifica√ß√£o espiritual (collection antiga)
    match /spiritual_certifications/{certificationId} {
      // Qualquer usu√°rio autenticado pode ler e escrever
      allow read, write: if request.auth != null;
    }
    
    // Regras para solicita√ß√µes de certifica√ß√£o espiritual (collection nova)
    match /certification_requests/{certificationId} {
      // Qualquer usu√°rio autenticado pode ler todas as certifica√ß√µes
      // (necess√°rio para exibir selo no perfil p√∫blico)
      allow read: if request.auth != null;
      
      // Usu√°rio pode criar sua pr√≥pria solicita√ß√£o
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // Apenas admins podem atualizar (aprovar/reprovar)
      allow update: if request.auth != null && 
        isAdmin(request.auth.uid);
      
      // Apenas admins podem deletar
      allow delete: if request.auth != null && 
        isAdmin(request.auth.uid);
    }
    
    // Regras para log de auditoria de certifica√ß√µes
    match /certification_audit_log/{logId} {
      // Apenas admins podem ler logs
      allow read: if request.auth != null && 
        isAdmin(request.auth.uid);
      
      // Apenas sistema pode criar logs (via Cloud Functions)
      // Usu√°rios autenticados podem criar para permitir Cloud Functions
      allow create: if request.auth != null &&
        request.resource.data.keys().hasAll(['certificationId', 'userId', 'action', 'performedBy', 'performedAt', 'method']) &&
        request.resource.data.action in ['approved', 'rejected', 'token_invalid', 'token_expired'] &&
        request.resource.data.method in ['email', 'panel', 'api'];
      
      // Ningu√©m pode atualizar ou deletar logs (imut√°veis)
      allow update, delete: if false;
    }
    
    // Regras para tokens de aprova√ß√£o/reprova√ß√£o
    match /certification_tokens/{tokenId} {
      // Apenas sistema pode criar tokens (via Cloud Functions)
      allow create: if request.auth != null;
      
      // Apenas sistema pode ler tokens (via Cloud Functions)
      allow read: if request.auth != null;
      
      // Apenas sistema pode marcar token como usado
      allow update: if request.auth != null &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['used', 'usedAt']);
      
      // Tokens n√£o podem ser deletados (manter hist√≥rico)
      allow delete: if false;
    }
    
    
    // ===== REGRA CATCH-ALL PARA DESENVOLVIMENTO =====
    // ‚ö†Ô∏è  ATEN√á√ÉO: Esta regra permite acesso amplo para qualquer cole√ß√£o n√£o mapeada acima
    // ‚úÖ POSICIONADA NO FINAL: Funciona como fallback quando nenhuma regra espec√≠fica se aplica
    // üéØ PRODU√á√ÉO: Refinar regras espec√≠ficas e remover esta regra depois
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
